/*!
 * @name     wp-player
 * @desc     初始化播放器。
 * @depend   jQuery, SoundManager2
 * @author   M.J
 * @date     2014-12-21
 * @update   2017-6-12
 * @URL      http://webjyh.com
 * @Github   https://github.com/webjyh/WP-Player
 * @reutn    {jQuery}
 * @version  2.6.1
 * 
 */
~function(t,i){var s=function(s,e){i.setup({url:e.swf,debugMode:!1}),this.index=0,this.url=e.url,this.nonce=e.nonce,this.img=e.img,this.IE6=!-[1]&&!window.XMLHttpRequest,this.single=e.single,this.lyric=null,this.offset={},this.mark=null,this.lyricH=300,this.line=27,this.isLoad=!1,this.$elem=t(s),this.first=!0,this.isMobile="createTouch"in document&&!("onmousemove"in document)||/(iPhone|iPad|iPod)/i.test(navigator.userAgent),this.getDOM(this.$elem).getAttr().init()};s.prototype={init:function(){var t=this.attr,i=this.DOM;i.time.text("00:00"),i.title.text("Loading..."),i.author.text("Loading..."),t.lyric&&this.isMobile&&i.lyricsbtn.hide(),this[t.id?"actions":"localAction"]()},actions:function(){var i=this;t.ajax({url:this.url,type:"post",headers:{nonce:this.nonce},data:{action:"wpplayer",type:this.attr.type,id:this.attr.id,source:this.attr.source}}).done(function(t){t.status&&t.data.list&&t.data.list.length&&(i.data=t.data.list,i.createList().getSongInfo().addEvent())}).fail(function(){window.console&&window.console.info("获取歌曲列表失败")})},getSongInfo:function(i,s){var e=void 0===i?0:i,a=this,n=this.DOM,r={};if(n.time.text("00:00"),n.title.text("Loading..."),n.author.text("Loading..."),1!=this.attr.random||s||(e=this.random()),r=this.data[e],this.index=e,this.setList(),r&&!r.url&&!this.isLoad)return this.isLoad=!0,t.ajax({url:this.url,type:"post",headers:{nonce:this.nonce},data:{action:"wpplayerGetInfo",id:r.id,pic_id:r.pic_id,url_id:r.url_id,lyric_id:r.lyric_id,source:this.attr.source}}).done(function(t){a.isLoad=!1,t.status&&t.data&&(a.data[e].lyric=t.data.lyric.lyric,a.data[e].pic=t.data.pic.url,a.data[e].url=t.data.url.url,a.createSound(e))}).fail(function(){a.isLoad=!1,window.console&&window.console.info("获取歌曲失败")}),this},localAction:function(){function i(t){var i=t.length-1;return t.substr(0,i).split("|")}if(void 0===this.attr.address)return!1;var s=[],e=0,a=i(this.attr.title),n=i(this.attr.author),r=i(this.attr.address),o=i(this.attr.thumb);t.each(a,function(t){s.push({name:a[t],lyric:"",artist:[n[t]],url:r[t],pic:o[t]})}),this.data=s,this.createList(),1==this.attr.random&&(e=this.random()),this.index=e,this.setList(),this.createSound(this.index).addEvent()},createList:function(){for(var i=0,e="",a=this.DOM,n=this.data,r=n.length;i<r;i++){var o=i%2?"odd":"";e+=s.template.replace("{i}",i).replace("{class}",o).replace("{author}",n[i].artist.join("/")).replace("{serial}",i+1).replace("{title}",n[i].name)}return t(e).appendTo(a.list.children("ul")).eq(this.index).addClass("current"),a.list.height(a.list.outerHeight()),this},createSound:function(t){var s=this,e=void 0===t?0:t,a=this.data[e],n=this.DOM,r="true"==this.single&&"1"==this.attr.autoplay&&!this.isMobile;if(n.title.text(a.name),n.author.text(a.artist.join("/")),n.thumb.find("img").attr("src",a.pic),!(this.data.length>1)||a.url)return i.onready(function(){"object"==typeof s.sound&&s.sound.destruct(),s.timeReady=!!s.isMobile,s.sound=i.createSound({url:a.url,onload:function(){s.timeReady=!0},onplay:function(){s.setPlay()},onresume:function(){s.setPlay()},onpause:function(){s.setStop()},onfinish:function(){s.nextSound()},whileplaying:function(){var t,i,e,a,r=this.position/this.duration*100,o=r>100?"100%":r.toFixed(5)+"%";s.timeReady?(a="-",t=Math.floor((this.duration-this.position)/1e3),i=s.formatNumber(Math.floor(t/60)),e=s.formatNumber(Math.floor(t%60))):(a="",i="00",e="00"),n.playbar.width(o),n.time.text(a+i+":"+e),s.attr.lyric&&s.lyric&&!s.isMobile&&s.setLyric(this.position)},whileloading:function(){var t=this.bytesTotal&&this.bytesLoaded!=this.bytesTotal?this.bytesLoaded/this.bytesTotal*100:100;n.seekbar.width(t+"%")},onerror:function(t,i){window.console&&console.log(this.id+" failed?",t,i),s.data.length>1&&s.nextSound()}}),s.soundEvent(),s.attr.lyric&&!s.isMobile&&(a.lyric?s.createLyric(a.lyric):s.noLyric()),!s.first||r?s.sound.play():s.first=!1}),this;this.nextSound()},createLyric:function(i){this.emptyLyric();for(var s=0,e=[],a=(y=i.split("\n")).length,n=this.DOM,r=/\[(\d+:\d+.?\d+)\]/g,o=/[^\[(\d+):(\d+.?\d+)\]\s*].+/g,l="";s<a;s++){var h=t.trim(y[s]).match(r);if(t.isArray(h))for(var d=t.trim(y[s]).match(o),u=0;u<h.length;u++){var c=h[u].replace("[","").replace("]","").split(":"),p=60*c[0]+Math.floor(c[1]);e.push({time:p,lyric:t.isArray(d)?d[0]:"&nbsp;"})}}if(!e.length)return this.noLyric(),!1;for(s=0,a=e.length;s<a;s++)for(u=s;u<a;u++)if(e[s].time>e[u].time){var f=e[s];e[s]=e[u],e[u]=f}for(this.lyric={},s=0;s<a;s++)l+="<li>"+e[s].lyric+"</li>",this.lyric[e[s].time]=s;n.lyricList=t(l).appendTo(n.lyrics.children("ul"));var y=n.lyrics.children("ul").height(),m=Math.floor(this.lyricH/2),g=y-m;this.offset={min:Math.floor(m/this.line),max:Math.floor(g/this.line)}},setLyric:function(t){var i=this.DOM,s=this.offset,e=Math.floor(t/1e3),a=this.lyric&&this.lyric[e],n=0;void 0!==a&&i.lyricList&&this.mark!=a&&(a>=s.min&&(n=a-s.min),a>=s.max&&(n=s.max-s.min),i.lyricList.removeClass("current").eq(a).addClass("current"),i.lyrics.children("ul").css("margin-top",-n*this.line),this.mark=a)},emptyLyric:function(){var t=this.DOM;this.lyric=null,t.lyrics.children("ul").css("margin-top",0).html("")},noLyric:function(t){var i=this.DOM,s=void 0===t?"暂无歌词":t;this.lyric=null,i.lyrics.children("ul").html("<li>"+s+"</li>")},addEvent:function(){var i,s,e=this.DOM,a=this,n=this.isMobile?"touchend":"click";e.listbtn.on(n,function(){var i=t(this).hasClass("wp-player-open");e.lyrics.children("ul").stop(!0,!0).hide(),t(this)[i?"removeClass":"addClass"]("wp-player-open"),e.list.show()[i?"removeClass":"addClass"]("wp-player-list-hide")}),this.attr.lyric&&e.lyricsbtn.on(n,function(){e.listbtn.addClass("wp-player-open"),e.list.hide(),e.lyrics.children("ul").stop(!0,!0).fadeIn()});var r=function(i){var s=void 0===i?t(this):t(i).parents("li"),e=parseInt(s.attr("data-index"),10),n=s.hasClass("current")&&a.sound.playState>0;e<0||e>a.data.length-1?a.index=0:a.index=e,n&&!a.sound.paused?a.sound.pause():n&&a.sound.paused?a.sound.resume():(a.sound&&a.sound.pause(),a.reset().setList(),a.data[a.index]&&a.data[a.index].url?a.createSound(a.index):a.getSongInfo(a.index,!0))};return this.isMobile?(e.list[0].addEventListener("touchstart",function(t){var e=t.target.nodeName;if("A"===e||"SPAN"===e){var a=t.touches[0];i=a.clientX,s=a.clientY}},!1),e.list[0].addEventListener("touchend",function(t){var e=t.target.nodeName;if("A"===e||"SPAN"===e){var a=t.changedTouches[0],n=a.clientX,o=a.clientY;Math.abs(i-n)<6&&Math.abs(s-o)<6&&(r(t.target),i=null,s=null)}},!1)):e.list.on("click","li",function(){r.call(this)}),this},soundEvent:function(){var t=this.DOM,i=this,s=this.isMobile?"touchend":"click";return this.isMobile||t.seekbar.off().on(s,function(t){i.seekbar(t)}),t.play.off().on(s,function(){i.play()}),t.stop.off().on(s,function(){i.stop()}),this.data.length>1&&(t.previous.off().on(s,function(){i.prevSound()}),t.next.off().on(s,function(){i.nextSound()})),this},seekbar:function(t){var i=this.DOM,s=(t.offsetX?t.offsetX:(t.clientX-i.progress.offset().left).toFixed(0))/i.progress.width()*this.sound.duration;s<0&&(s=0),s>this.sound.duration&&(s=this.sound.duration),this.sound.setPosition(s),i.lyricList&&i.lyricList.removeClass("current")},play:function(){this.sound[this.sound.playState<1?"play":"resume"]()},stop:function(){this.sound.pause()},prevSound:function(){1==this.attr.random?this.index=this.random():--this.index<0&&(this.index=this.data.length-1),this.sound&&this.sound.pause(),this.reset().setList(),this.data[this.index]&&this.data[this.index].url?this.createSound(this.index):this.getSongInfo(this.index,!0)},nextSound:function(){var t=this.data.length-1;1==this.attr.random?this.index=this.random():++this.index>t&&(this.index=0),this.sound&&this.sound.pause(),this.reset().setList(),this.data[this.index]&&this.data[this.index].url?this.createSound(this.index):this.getSongInfo(this.index,!0)},setPlay:function(){var t=this.DOM;return t.playing.stop(!0,!0)[this.IE6||this.isMobile?"show":"fadeIn"](),t.play.hide(),t.stop.show(),this},setStop:function(){var t=this.DOM;return t.playing.stop(!0,!0)[this.IE6||this.isMobile?"hide":"fadeOut"](),t.play.show(),t.stop.hide(),this},random:function(){return this.data&&1!==this.data.length?Math.floor(Math.random()*this.data.length)||0:0},reset:function(){var t=this.DOM;return this.setStop(),t.seekbar.width(0),t.playbar.width(0),this},setList:function(){var t=this.DOM,i=this.index,s=t.list.find("li").eq(0).outerHeight(),e=Math.floor(t.list.height()/s),a=Math.floor(e/2),n=a,r=this.data.length-a;return this.data.length>e&&(i<=n&&t.list.scrollTop(0),i>n&&i<r&&t.list.scrollTop((i-a)*s),i>=r&&t.list.scrollTop(t.list.children("ul").outerHeight())),t.list.find("li").removeClass("current").eq(this.index).addClass("current"),this},getDOM:function(i){var s=i[0].getElementsByTagName("*"),e={};e.wrap=i;for(var a=0;a<s.length;a++)s[a].className.indexOf("wp-player")>-1&&(e[s[a].className.replace("wp-player","").replace(/-/g,"")]=t(s[a]));return this.DOM=e,this},formatNumber:function(t){return t.toString().length<2?"0"+t:t},getAttr:function(){var t=this.DOM,i=t.wrap.attr("data-lyric"),s=void 0!==i&&"open"==i;return this.attr={source:t.wrap.attr("data-source"),type:t.wrap.attr("data-type"),id:t.wrap.attr("data-id"),title:t.wrap.attr("data-title"),author:t.wrap.attr("data-author"),address:t.wrap.attr("data-address"),thumb:t.wrap.attr("data-thumb"),autoplay:t.wrap.attr("data-autoplay"),random:t.wrap.attr("data-random"),lyric:s},this},destroy:function(){this.sound&&this.sound.unload(),this.sound="",this.attr.lyric&&(this.DOM.lyrics.children("ul").html(""),this.DOM.listbtn.trigger(this.isMobile?"touchend":"click").removeClass("wp-player-open")),this.reset(),this.DOM.list.removeClass("wp-player-list-hide").children("ul").html(""),this.DOM.thumb.children("img").attr("src",this.img),this.DOM.time.text("00:00"),this.DOM.title.text("Loading..."),this.DOM.author.text("Loading..."),this.DOM.wrap.data("WPPlayer",""),this.DOM.wrap.off().find("*").off(),this.index=0,this.lyric=null,this.offset={},this.mark=null,this.lyricH=300,this.line=27,this.isLoad=!1,this.first=!0,this.attr={},this.data=[],this.img=null,this.DOM={}},reload:function(){this.destroy(),this.getDOM(this.$elem).getAttr().init(),this.DOM.wrap.data("WPPlayer",this)}},s.template='<li data-index="{i}" class="{class}"><a href="javascript:void(0);"><span class="wp-player-list-author">{author}</span><span class="wp-player-list-order">{serial}</span><span class="wp-player-list-title">{title}</span></a></li>',t.fn.WPPlayer=function(i){return this.each(function(){var e=t(this);"string"==typeof i?e.data("WPPlayer")&&e.data("WPPlayer")[i]():e.data("WPPlayer",new s(this,i))})}}(jQuery,soundManager),jQuery('[data-wp-player="wp-player"]').WPPlayer(wp_player_params);